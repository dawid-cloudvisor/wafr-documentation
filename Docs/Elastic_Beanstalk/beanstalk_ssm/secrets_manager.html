<!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>How to use secrets manager secrets with Beanstalk</title>
        <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
        
    </head>
    <body class="vscode-body vscode-light">
        <h1 id="how-to-use-secrets-manager-secrets-with-beanstalk">How to use secrets manager secrets with Beanstalk</h1>
<ul>
<li><a href="#how-to-use-secrets-manager-secrets-with-beanstalk">How to use secrets manager secrets with Beanstalk</a>
<ul>
<li><a href="#create-the-secret">Create the secret</a></li>
<li><a href="#create-the-iam-policy-and-attach-it-to-the-instance-profile">Create the IAM policy and attach it to the instance profile</a></li>
<li><a href="#create-secrests-manager-endpoint-in-subnets-that-used-by-the-beanstalk-deployment">Create secrests manager endpoint in subnets that used by the beanstalk deployment</a></li>
<li><a href="#integrate-ebextensions-and-container_commands-in-your-custom-logic">Integrate '.ebextensions' and 'container_commands' in your custom logic</a></li>
<li><a href="#example-implementation">Example implementation</a></li>
</ul>
</li>
</ul>
<p>Unfortunately there is not an easy way currently. You need to implement your own logic to retrieve secrets manager secrets.</p>
<h2 id="create-the-secret">Create the secret</h2>
<p>Go to Secrets Manager AWS console in the region where your infra can be found
To store your secret create a custom secret in AWS-Secret-Manager. In secret manager you can create a new secret by clicking &quot;Store a new secret&quot;, then selecting &quot;Other type of secret&quot; and entering your secret key/value:
<img src="./ssm.png" alt="ssm">
At the next step you need to provide a Secret Name (say &quot;your_secret_name&quot;) and you can leave everything else to their default settings.</p>
<h2 id="create-the-iam-policy-and-attach-it-to-the-instance-profile">Create the IAM policy and attach it to the instance profile</h2>
<ol>
<li>Create a new (Customer Managed) IAM policy on the IAM AWS console with the content similar as below:</li>
</ol>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;Version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2012-10-17&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;Statement&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;Sid&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Getsecretvalue&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;Effect&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Allow&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;Action&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-string">&quot;secretsmanager:GetResourcePolicy&quot;</span><span class="hljs-punctuation">,</span>
          <span class="hljs-string">&quot;secretsmanager:GetSecretValue&quot;</span><span class="hljs-punctuation">,</span>
          <span class="hljs-string">&quot;secretsmanager:DescribeSecret&quot;</span><span class="hljs-punctuation">,</span>
          <span class="hljs-string">&quot;secretsmanager:ListSecretVersionIds&quot;</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;Resource&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;your-secret-arn&quot;</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><img src="./policy.png" alt="policy"></p>
<p>Change the &quot;Resource&quot; value with the arn of the secret you have created earlier.</p>
<ol start="2">
<li>Attach the policy to the EC2 instance profile</li>
</ol>
<p>Choose 'Roles' on the left side navigation panel on IAM console, and choose the profile  you want the plocy to attach to. In 'Permissions' section (Permission Policies) click on 'Add permissions' and choose attach policies. Then chose the policy that you have just created and attach it to the Role.</p>
<h2 id="create-secrests-manager-endpoint-in-subnets-that-used-by-the-beanstalk-deployment">Create secrests manager endpoint in subnets that used by the beanstalk deployment</h2>
<p>Go to VPC AWS console, and chose 'Endpoints' from left side menu. Follow <a href="https://docs.aws.amazon.com/vpc/latest/privatelink/create-interface-endpoint.html">this guide</a>.</p>
<p><img src="./endpoint.png" alt="endpoint"></p>
<h2 id="integrate-ebextensions-and-container_commands-in-your-custom-logic">Integrate '.ebextensions' and 'container_commands' in your custom logic</h2>
<p>In your application source on root level path create a folder called <code>.ebextensions</code>
here you can implement your custom logic that retrieves the secret value for you.</p>
<p>Read <a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/customize-containers-ec2.html#linux-container-commands:~:text=true%0A%20%20%20%20%20%20ensureRunning%3A%20true-,Container%20commands,-You%20can%20use">this guide about 'container_commands'</a> and <a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/environment-configuration-methods-before.html#:~:text=Use%20.ebextensions%20to%20configure%20options%20that%20are%20required%20to%20make%20your%20application%20work">this one about .ebextensions</a></p>
<h2 id="example-implementation">Example implementation</h2>
<pre><code class="language-sh"><span class="hljs-comment"># .ebextensions/setup-env.config</span>
container_commands:
  01-extract-env:
    <span class="hljs-built_in">env</span>:
      AWS_SECRET_ID:
        <span class="hljs-string">&quot;Fn::GetOptionSetting&quot;</span>:
          Namespace: <span class="hljs-string">&quot;aws:elasticbeanstalk:application:environment&quot;</span>
          OptionName: AWS_SECRET_ID
      AWS_REGION: {<span class="hljs-string">&quot;Ref&quot;</span> : <span class="hljs-string">&quot;AWS::Region&quot;</span>}
      ENVFILE: .<span class="hljs-built_in">env</span>

    <span class="hljs-built_in">command</span>: &gt;
        aws secretsmanager get-secret-value --secret-id <span class="hljs-variable">$AWS_SECRET_ID</span> --region <span class="hljs-variable">$AWS_REGION</span> |
        jq -r <span class="hljs-string">&#x27;.SecretString&#x27;</span> |
        jq -r <span class="hljs-string">&#x27;to_entries|map(&quot;\(.key)=\(.value|tostring)&quot;)|.[]&#x27;</span> &gt; <span class="hljs-variable">$ENVFILE</span>
</code></pre>
<p>Your application then needs to catch up the <code>.env</code> file</p>

        <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
        
    </body>
    </html>